<!-- AI Chat 模块 UI -->
<div class="tab-content ai-chat-tab-content theme-ai-chat" :class="getTabAnimationClass('ai-chat')">
  <div class="ai-chat-module">
    <!-- 侧边栏：对话历史列表 -->
    <div class="ai-chat-sidebar" :class="{ 'open': aiChatSidebarOpen }">
      <div class="ai-chat-sidebar-header">
        <h3>对话历史</h3>
        <button class="ai-chat-new-btn" @click="aiChatNewConversation">
          <i class="fas fa-plus"></i> 新对话
        </button>
      </div>
      <div class="ai-chat-conv-list">
        <div v-for="conv in aiChatConversations" :key="conv.id" class="ai-chat-conv-item"
          :class="{ active: aiChatCurrentConversation && aiChatCurrentConversation.id === conv.id }"
          @click="aiChatSelectConversation(conv)">
          <i class="fas fa-comment-alt" style="margin-right: 8px; opacity: 0.5;"></i>
          <span class="title">{{ conv.title }}</span>
          <button class="delete-btn" @click.stop="aiChatDeleteConversation(conv.id)" title="删除">
            <i class="fas fa-trash"></i>
          </button>
        </div>

        <div v-if="aiChatConversations.length === 0" class="ai-chat-empty" style="padding: 20px;">
          <i class="fas fa-comments" style="font-size: 24px;"></i>
          <p style="margin-top: 8px; font-size: 12px;">暂无对话</p>
        </div>
      </div>
    </div>

    <!-- 主聊天区域 -->
    <div class="ai-chat-main">
      <!-- 顶部工具栏 -->
      <div class="ai-chat-header">
        <div class="ai-chat-header-left">
          <!-- 移动端侧边栏切换 -->
          <button class="ai-chat-settings-btn" @click="aiChatSidebarOpen = !aiChatSidebarOpen" v-if="isMobile">
            <i class="fas fa-bars"></i>
          </button>
          <h2>{{ aiChatCurrentConversation ? aiChatCurrentConversation.title : 'AI Chat' }}</h2>
        </div>

        <div class="ai-chat-model-select">
          <!-- Provider 选择 -->
          <select v-model="aiChatCurrentProviderId" @change="aiChatOnProviderChange">
            <option value="">选择 Provider</option>
            <option v-for="p in aiChatProviders" :key="p.id" :value="p.id">{{ p.name }}</option>
          </select>

          <!-- 模型选择 -->
          <select v-model="aiChatCurrentModel" :disabled="!aiChatCurrentProviderId">
            <option value="">选择模型</option>
            <option v-for="m in aiChatCurrentProviderModels" :key="m.id" :value="m.id">{{ m.name || m.id }}</option>
          </select>
        </div>

        <div class="ai-chat-header-right">
          <button class="ai-chat-settings-btn" @click="aiChatShowProviderModal = true" title="Provider 设置">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>

      <!-- 消息列表 -->
      <div class="ai-chat-messages" ref="aiChatMessagesContainer">
        <!-- 空状态 -->
        <div v-if="aiChatMessages.length === 0" class="ai-chat-empty">
          <i class="fas fa-robot"></i>
          <h3>开始新的对话</h3>
          <p>选择一个 Provider 和模型，然后输入你的问题</p>
        </div>

        <!-- 消息列表 -->
        <div v-for="msg in aiChatMessages" :key="msg.id" class="ai-chat-message" :class="msg.role">
          <div class="avatar">
            <i :class="msg.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
          </div>
          <div class="content" v-html="msg.role === 'assistant' ? aiChatRenderMarkdown(msg.content) : msg.content">
          </div>
        </div>

        <!-- 正在输入指示器 -->
        <div v-if="aiChatIsStreaming" class="ai-chat-message assistant">
          <div class="avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="content">
            <span v-html="aiChatRenderMarkdown(aiChatStreamingContent)"></span>
            <span class="ai-chat-typing-cursor"></span>
          </div>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="ai-chat-input-area">
        <div class="ai-chat-input-wrapper">
          <textarea class="ai-chat-textarea" v-model="aiChatInputMessage"
            @keydown.enter.exact.prevent="aiChatSendMessage" @keydown.shift.enter.prevent="aiChatInputMessage += '\n'"
            placeholder="输入消息... (Enter 发送, Shift+Enter 换行)" :disabled="aiChatIsStreaming" rows="1"
            ref="aiChatInput"></textarea>

          <button v-if="aiChatIsStreaming" class="ai-chat-send-btn stop" @click="aiChatStopStreaming" title="停止生成">
            <i class="fas fa-stop"></i>
          </button>
          <button v-else class="ai-chat-send-btn" @click="aiChatSendMessage"
            :disabled="!aiChatInputMessage.trim() || !aiChatCurrentProviderId" title="发送">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Provider 设置弹窗 -->
    <div v-if="aiChatShowProviderModal" class="ai-chat-provider-modal" @click.self="aiChatShowProviderModal = false">
      <div class="ai-chat-provider-content">
        <div class="ai-chat-provider-header">
          <h3>Provider 设置</h3>
          <button class="ai-chat-settings-btn" @click="aiChatShowProviderModal = false">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="ai-chat-provider-body">
          <!-- 已有 Provider 列表 -->
          <div class="ai-chat-provider-list" v-if="aiChatProviders.length > 0">
            <div v-for="provider in aiChatProviders" :key="provider.id" class="ai-chat-provider-item">
              <div class="info">
                <span class="name">{{ provider.name }}</span>
                <span class="type">{{ provider.type }}</span>
                <span v-if="provider.hasKey" style="color: var(--success-color); font-size: 12px;">
                  <i class="fas fa-check-circle"></i> 已配置
                </span>
              </div>
              <div class="ai-chat-provider-actions">
                <button class="btn btn-sm btn-secondary" @click="aiChatEditProvider(provider)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" @click="aiChatDeleteProvider(provider.id)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 添加/编辑表单 -->
          <div class="ai-chat-provider-form">
            <h4 style="margin: 0 0 16px 0;">{{ aiChatEditingProvider ? '编辑 Provider' : '添加 Provider' }}</h4>

            <div class="form-group">
              <label>名称</label>
              <input type="text" v-model="aiChatProviderForm.name" placeholder="例如: OpenAI" />
            </div>

            <div class="form-group">
              <label>类型</label>
              <select v-model="aiChatProviderForm.type">
                <option value="openai">OpenAI 兼容</option>
                <option value="ollama">Ollama 本地</option>
              </select>
            </div>

            <div class="form-group">
              <label>Base URL</label>
              <input type="text" v-model="aiChatProviderForm.base_url" placeholder="https://api.openai.com/v1" />
            </div>

            <div class="form-group">
              <label>API Key</label>
              <input type="password" v-model="aiChatProviderForm.api_key" placeholder="sk-..." />
            </div>

            <div class="form-group">
              <label>默认模型</label>
              <input type="text" v-model="aiChatProviderForm.default_model" placeholder="gpt-4o" />
            </div>

            <div style="display: flex; gap: 12px; margin-top: 16px;">
              <button class="btn btn-primary" @click="aiChatSaveProvider">
                <i class="fas fa-save"></i> 保存
              </button>
              <button v-if="aiChatEditingProvider" class="btn btn-secondary" @click="aiChatResetProviderForm">
                取消
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>