<div class="tab-content music-tab-content theme-music music-module apple-style"
    :class="[getTabAnimationClass('music'), { 'player-active': musicShowFullPlayer }]">
    <!-- Background Content that will scale down -->
    <div class="music-bg-wrapper">
        <!-- Section Tabs (Grid 3-Column: Left | Center | Right) -->
        <div class="sec-tabs music-sec-tabs">
            <!-- Left: Close Playlist Button (only when detail is open) -->
            <div class="sec-tabs-left-controls">
                <button v-if="musicShowDetail && musicCurrentPlaylistDetail" class="btn btn-secondary music-back-btn"
                    @click="musicShowDetail = false" title="返回" aria-label="返回歌单列表">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                    <span>返回</span>
                </button>
            </div>

            <!-- Center: Tabs -->
            <div class="server-tabs-scroll-wrapper">
                <button class="tab-btn" :class="{ active: musicCurrentTab === 'home' }"
                    @click="musicCurrentTab = 'home'; musicShowDetail = false">
                    <i class="fas fa-home" aria-hidden="true"></i> 首页
                </button>
                <button class="tab-btn" :class="{ active: musicCurrentTab === 'discover' }"
                    @click="musicCurrentTab = 'discover'; musicShowDetail = false; musicHotPlaylists.length === 0 && musicLoadHotPlaylists()">
                    <i class="fas fa-compass" aria-hidden="true"></i> 发现
                </button>
                <button class="tab-btn" :class="{ active: musicCurrentTab === 'library' }"
                    @click="musicCurrentTab = 'library'; musicShowDetail = false">
                    <i class="fas fa-music" aria-hidden="true"></i> 音乐库
                </button>
                <!-- 搜索结果标签 (动态显示，双击关闭) -->
                <button v-if="musicShowSearchTab" class="tab-btn" :class="{ active: musicCurrentTab === 'search' }"
                    @click="musicCurrentTab = 'search'; musicShowDetail = false"
                    @dblclick.prevent="musicCloseSearchTab()" title="双击关闭">
                    <i class="fas fa-search" aria-hidden="true"></i> 搜索
                    <span class="tab-close-hint" @click.stop="musicCloseSearchTab()">×</span>
                </button>
            </div>

            <!-- Right: Search & User -->
            <div class="sec-tabs-right-controls">
                <div class="search-pill">
                    <label for="music-search" class="sr-only">搜索音乐</label>
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="text" id="music-search" v-model="musicSearchKeyword"
                        @keyup.enter="musicSearch(); musicCurrentTab = 'search'; musicShowDetail = false"
                        placeholder="搜索..." aria-label="搜索音乐">
                </div>

                <template v-if="musicUser">
                    <div class="user-pill-wrapper" style="position: relative;">
                        <div class="user-pill" @click="musicShowUserDropdown = !musicShowUserDropdown">
                            <img :src="musicUser.avatarUrl" :alt="musicUser.nickname + '的头像'">
                        </div>
                        <!-- User Dropdown -->
                        <div v-if="musicShowUserDropdown" class="music-user-dropdown">
                            <div class="dropdown-header">
                                <img :src="musicUser.avatarUrl" class="dropdown-avatar">
                                <span class="dropdown-name">{{ musicUser.nickname }}</span>
                            </div>
                            <div class="dropdown-stats">
                                <div class="stat-item">
                                    <span class="stat-value">{{ musicMyPlaylists.length }}</span>
                                    <span class="stat-label">歌单</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">{{ musicCollectedPlaylists.length }}</span>
                                    <span class="stat-label">收藏</span>
                                </div>
                            </div>
                            <div class="dropdown-actions">
                                <button class="dropdown-btn" @click="musicLogout(); musicShowUserDropdown = false">
                                    <i class="fas fa-power-off"></i> 退出登录
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <template v-else>
                    <div class="login-text-btn" @click="musicShowLoginModal = true; musicGenerateLoginQr()">
                        登录
                    </div>
                </template>
            </div>
        </div>

        <!-- Main Content Area with Transitions -->
        <div class="music-main-content" v-show="!musicShowDetail">

            <!-- === HOME TAB: Quick Access === -->
            <div v-show="musicCurrentTab === 'home'" class="music-page-home sub-tab-content quick-fade-in">

                <div class="library-header">
                    <img v-if="musicUser" :src="musicUser.avatarUrl" class="header-avatar">
                    <div class="header-text">
                        <h1>{{ musicUser ? musicUser.nickname : '欢迎使用音乐' }}</h1>
                    </div>
                </div>

                <!-- Quick Access Grid -->
                <div class="quick-access-section">
                    <!-- <h3 class="section-title">快捷入口</h3> -->
                    <div class="quick-grid-home">
                        <div class="quick-item" @click="musicLoadDailyRecommend">
                            <div class="quick-cover daily-cover">
                                <div class="cal-day">{{ new Date().getDate() }}</div>
                            </div>
                            <div class="quick-info">
                                <div class="title">每日推荐</div>
                                <div class="sub">Daily Mix</div>
                            </div>
                        </div>
                        <div class="quick-item" @click="musicLoadPrivateFM">
                            <div class="quick-cover fm-cover">
                                <div class="fm-badge">FM</div>
                            </div>
                            <div class="quick-info">
                                <div class="title">私人 FM</div>
                                <div class="sub">Just for you</div>
                            </div>
                        </div>
                        <!-- 我喜欢的音乐 -->
                        <div v-if="musicUser && musicMyPlaylists.length > 0" class="quick-item"
                            @click="musicLoadPlaylistDetail(musicMyPlaylists[0].id)">
                            <div class="quick-cover">
                                <img :src="(musicMyPlaylists[0].cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=200y200'"
                                    @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=200y200'">
                            </div>
                            <div class="quick-info">
                                <div class="title">我喜欢的音乐</div>
                                <div class="sub">{{ musicMyPlaylists[0].trackCount }} 首</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 每日推荐歌单展示 -->
                <div v-if="musicUser" class="daily-recommend-section">
                    <div class="section-header">
                        <h3 class="section-title">每日推荐</h3>
                        <span v-if="musicDailyRecommend.length > 0" class="section-sub">{{ musicDailyRecommend.length }}
                            首</span>
                    </div>

                    <!-- 骨架屏加载状态 -->
                    <div v-if="musicRecommendLoading" class="playlist-wall">
                        <div class="wall-item" v-for="n in 6" :key="'skeleton-daily-' + n">
                            <div class="wall-cover skeleton skeleton-card"></div>
                            <div class="skeleton skeleton-text" style="margin-top: 10px;"></div>
                            <div class="skeleton skeleton-text-short"></div>
                        </div>
                    </div>

                    <!-- 已加载的每日推荐歌曲 -->
                    <div v-else-if="musicDailyRecommend.length > 0" class="playlist-wall">
                        <div class="wall-item" v-for="(song, index) in musicDailyRecommend" :key="song.id"
                            @click="musicPlayDailyFromIndex(index)">
                            <div class="wall-cover">
                                <img :src="(song.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                    @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                                <div class="wall-play-overlay"><i class="fas fa-play"></i></div>
                                <div class="play-count"><i class="fas fa-music"></i> {{ index + 1 }}</div>
                            </div>
                            <div class="wall-title">{{ song.name }}</div>
                            <div class="wall-sub">{{ song.artists }}</div>
                        </div>
                    </div>

                    <!-- 未加载状态 -->
                    <div v-else class="empty-state-mini" style="padding: 30px;">
                        <button class="btn btn-secondary" @click="musicLoadDailyRecommendForHome">
                            <i class="fas fa-sync-alt"></i> 加载每日推荐
                        </button>
                    </div>
                </div>

                <div v-if="!musicUser" class="empty-state">
                    <i class="fas fa-music"></i>
                    <p>登录后查看个性化推荐</p>
                    <button class="btn btn-primary"
                        @click="musicShowLoginModal = true; musicGenerateLoginQr()">立即登录</button>
                </div>

            </div>

            <!-- === DISCOVER TAB: Hot Playlists === -->
            <div v-show="musicCurrentTab === 'discover'" class="music-page-discover sub-tab-content quick-fade-in">

                <h2 class="page-title">发现音乐</h2>

                <!-- 骨架屏加载状态 -->
                <div v-if="musicPlaylistsLoading" class="playlist-wall">
                    <div class="wall-item" v-for="n in 8" :key="'skeleton-' + n">
                        <div class="wall-cover skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text-short"></div>
                    </div>
                </div>

                <div v-else-if="musicHotPlaylists.length > 0" class="playlist-wall">
                    <div class="wall-item" v-for="pl in musicHotPlaylists" :key="pl.id"
                        @click="musicLoadPlaylistDetail(pl.id)" tabindex="0" role="button"
                        @keyup.enter="musicLoadPlaylistDetail(pl.id)">
                        <div class="wall-cover">
                            <img :src="(pl.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                :alt="pl.name + ' 歌单封面'"
                                @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                            <div class="wall-play-overlay"><i class="fas fa-play" aria-hidden="true"></i></div>
                            <div class="play-count"><i class="fas fa-play" aria-hidden="true"></i> {{
                                Math.floor(pl.playCount / 10000) }}万
                            </div>
                        </div>
                        <div class="wall-title">{{ pl.name }}</div>
                        <div class="wall-sub">{{ pl.creator }}</div>
                    </div>
                </div>

                <div v-else class="empty-state">
                    <i class="fas fa-compass" aria-hidden="true"></i>
                    <p>暂无热门歌单</p>
                    <button class="btn btn-secondary" @click="musicLoadHotPlaylists">
                        <i class="fas fa-redo" aria-hidden="true"></i> 重新加载
                    </button>
                </div>

            </div>

            <!-- === LIBRARY TAB: User Playlists === -->
            <div v-show="musicCurrentTab === 'library'" class="music-page-library sub-tab-content quick-fade-in">

                <h2 class="page-title">我的音乐库</h2>

                <template v-if="musicUser">
                    <!-- Sub Tabs for Playlists -->
                    <div class="sub-tabs">
                        <span class="active">全部歌单</span>
                    </div>

                    <!-- User Created Playlists -->
                    <div v-if="musicMyPlaylists.length > 0" class="playlist-section">
                        <h4 class="sub-section-title">创建的歌单 ({{ musicMyPlaylists.length }})</h4>
                        <div class="playlist-wall">
                            <div class="wall-item" v-for="pl in musicMyPlaylists" :key="pl.id"
                                @click="musicLoadPlaylistDetail(pl.id)">
                                <div class="wall-cover">
                                    <img :src="(pl.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                        @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                                    <div class="wall-play-overlay"><i class="fas fa-play"></i></div>
                                </div>
                                <div class="wall-title">{{ pl.name }}</div>
                                <div class="wall-sub">{{ pl.trackCount }} songs</div>
                            </div>
                        </div>
                    </div>

                    <!-- Collected Playlists -->
                    <div v-if="musicCollectedPlaylists.length > 0" class="playlist-section">
                        <h4 class="sub-section-title">收藏的歌单 ({{ musicCollectedPlaylists.length }})</h4>
                        <div class="playlist-wall">
                            <div class="wall-item" v-for="pl in musicCollectedPlaylists" :key="pl.id"
                                @click="musicLoadPlaylistDetail(pl.id)">
                                <div class="wall-cover">
                                    <img :src="(pl.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                        @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                                    <div class="wall-play-overlay"><i class="fas fa-play"></i></div>
                                </div>
                                <div class="wall-title">{{ pl.name }}</div>
                                <div class="wall-sub">{{ pl.trackCount }} songs</div>
                            </div>
                        </div>
                    </div>
                </template>

                <div v-else class="empty-state">
                    <i class="fas fa-music"></i>
                    <p>登录后查看您的音乐库</p>
                    <button class="btn btn-primary"
                        @click="musicShowLoginModal = true; musicGenerateLoginQr()">立即登录</button>
                </div>

            </div>

            <!-- === SEARCH TAB === -->
            <div v-show="musicCurrentTab === 'search'" class="music-page-search sub-tab-content quick-fade-in">

                <h2 class="page-title">搜索: {{ musicSearchKeyword }}</h2>

                <!-- 搜索类型切换 -->
                <div class="sub-tabs" style="margin-bottom: 20px;">
                    <span :class="{ active: musicSearchType === 'songs' }" @click="musicSwitchSearchType('songs')">
                        <i class="fas fa-music"></i> 歌曲
                    </span>
                    <span :class="{ active: musicSearchType === 'playlists' }"
                        @click="musicSwitchSearchType('playlists')">
                        <i class="fas fa-list"></i> 歌单
                    </span>
                    <span :class="{ active: musicSearchType === 'artists' }" @click="musicSwitchSearchType('artists')">
                        <i class="fas fa-user"></i> 歌手
                    </span>
                </div>

                <div v-if="musicSearchLoading" class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i> 搜索中...
                </div>

                <!-- 歌曲搜索结果 -->
                <template v-else-if="musicSearchType === 'songs'">
                    <div v-if="musicSearchResults.length > 0" class="music-song-list"
                        @scroll="$event.target.scrollHeight - $event.target.scrollTop <= $event.target.clientHeight + 100 && musicSearchHasMore && !musicSearchLoadingMore && musicSearch(true)">
                        <div class="music-song-item" v-for="(song, index) in musicSearchResults" :key="song.id"
                            @click="musicPlay(song)">
                            <img class="music-song-cover"
                                :src="(song.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=100y100'"
                                @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=100y100'">
                            <div class="music-song-info">
                                <div class="music-song-name">{{ song.name }}</div>
                                <div class="music-song-artist">{{ song.artists }} - {{ song.album }}</div>
                            </div>
                            <div class="song-duration">{{ formatMusicTime(song.duration) }}</div>
                        </div>
                        <!-- 加载更多 -->
                        <div v-if="musicSearchLoadingMore" class="music-load-more">
                            <i class="fas fa-spinner fa-spin"></i> 加载更多...
                        </div>
                        <div v-else-if="!musicSearchHasMore" class="empty-state-mini">
                            已加载全部结果
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>未找到相关歌曲</p>
                    </div>
                </template>

                <!-- 歌单搜索结果 -->
                <template v-else-if="musicSearchType === 'playlists'">
                    <div v-if="musicSearchPlaylists.length > 0" class="playlist-wall"
                        @scroll="$event.target.scrollHeight - $event.target.scrollTop <= $event.target.clientHeight + 100 && musicSearchHasMore && !musicSearchLoadingMore && musicSearch(true)">
                        <div class="wall-item" v-for="playlist in musicSearchPlaylists" :key="playlist.id"
                            @click="musicLoadPlaylistDetail(playlist.id)">
                            <div class="wall-cover">
                                <img :src="(playlist.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                    @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                                <div class="wall-play-overlay"><i class="fas fa-play"></i></div>
                                <div class="play-count"><i class="fas fa-play"></i> {{ (playlist.playCount /
                                    10000).toFixed(1) }}万</div>
                            </div>
                            <div class="wall-title">{{ playlist.name }}</div>
                            <div class="wall-sub">{{ playlist.creator }} · {{ playlist.trackCount }}首</div>
                        </div>
                    </div>
                    <div v-if="musicSearchLoadingMore" class="music-load-more" style="margin-top: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> 加载更多...
                    </div>
                    <div v-else-if="musicSearchPlaylists.length === 0" class="empty-state">
                        <i class="fas fa-list"></i>
                        <p>未找到相关歌单</p>
                    </div>
                </template>

                <!-- 歌手搜索结果 -->
                <template v-else-if="musicSearchType === 'artists'">
                    <div v-if="musicSearchArtists.length > 0" class="playlist-wall"
                        @scroll="$event.target.scrollHeight - $event.target.scrollTop <= $event.target.clientHeight + 100 && musicSearchHasMore && !musicSearchLoadingMore && musicSearch(true)">
                        <div class="wall-item" v-for="artist in musicSearchArtists" :key="artist.id"
                            @click="musicLoadArtistSongs(artist.id, artist.name)">
                            <div class="wall-cover" style="border-radius: 50%;">
                                <img :src="(artist.cover || 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg') + '?param=300y300'"
                                    style="border-radius: 50%;"
                                    @error="$event.target.src='https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg?param=300y300'">
                                <div class="wall-play-overlay" style="border-radius: 50%;"><i class="fas fa-user"></i>
                                </div>
                            </div>
                            <div class="wall-title">{{ artist.name }}</div>
                            <div class="wall-sub">{{ artist.alias || (artist.albumCount + '张专辑') }}</div>
                        </div>
                    </div>
                    <div v-if="musicSearchLoadingMore" class="music-load-more" style="margin-top: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> 加载更多...
                    </div>
                    <div v-else-if="musicSearchArtists.length === 0" class="empty-state">
                        <i class="fas fa-user"></i>
                        <p>未找到相关歌手</p>
                    </div>
                </template>

            </div>

        </div>

        <!-- Playlist Detail (moved outside main content for proper layout) -->
        <transition name="slide-up">
            <div class="music-playlist-detail-page" v-if="musicShowDetail">
                <!-- 骨架屏加载状态 -->
                <div class="music-detail-content" v-if="!musicCurrentPlaylistDetail">
                    <div class="music-detail-info">
                        <div class="music-detail-cover skeleton skeleton-card"></div>
                        <div class="music-detail-meta">
                            <div class="skeleton skeleton-text" style="width: 60%; height: 28px; margin-bottom: 12px;">
                            </div>
                            <div class="skeleton skeleton-text" style="width: 30%; height: 16px; margin-bottom: 8px;">
                            </div>
                            <div class="skeleton skeleton-text" style="width: 80%; height: 14px; margin-bottom: 16px;">
                            </div>
                            <div class="skeleton" style="width: 100px; height: 36px; border-radius: 18px;"></div>
                        </div>
                    </div>
                    <div class="music-song-list">
                        <div class="music-song-item" v-for="n in 8" :key="'skeleton-song-' + n">
                            <div class="music-song-index skeleton" style="width: 20px; height: 16px;"></div>
                            <div class="music-song-info">
                                <div class="skeleton skeleton-text"
                                    style="width: 70%; height: 16px; margin-bottom: 6px;"></div>
                                <div class="skeleton skeleton-text-short" style="width: 50%;"></div>
                            </div>
                            <div class="skeleton" style="width: 40px; height: 14px;"></div>
                        </div>
                    </div>
                </div>
                <!-- 实际内容 -->
                <div class="music-detail-content" v-else>
                    <div class="music-detail-info">
                        <img :src="musicCurrentPlaylistDetail.cover + '?param=400y400'" class="music-detail-cover"
                            :alt="musicCurrentPlaylistDetail.name + ' 封面'">
                        <div class="music-detail-meta">
                            <div class="music-detail-name">{{ musicCurrentPlaylistDetail.name }}</div>
                            <div class="music-detail-creator">{{ musicCurrentPlaylistDetail.creator }}</div>
                            <div class="music-detail-desc">{{ musicCurrentPlaylistDetail.description }}</div>
                            <button class="btn btn-primary"
                                @click="musicPlayPlaylist(musicCurrentPlaylistDetail.tracks)">
                                <i class="fas fa-play" aria-hidden="true"></i> 播放全部
                            </button>
                        </div>
                    </div>

                    <div class="music-song-list" ref="musicSongList" @scroll="handlePlaylistScroll">
                        <div class="music-song-item"
                            v-for="(song, index) in (musicCurrentPlaylistDetail.tracks || []).slice(0, musicPlaylistVisibleCount)"
                            :key="song.id" @click="musicPlay(song)" tabindex="0" @keyup.enter="musicPlay(song)"
                            :class="{ playing: musicCurrentSong && song.id === musicCurrentSong.id }">
                            <div class="music-song-index">{{ index + 1 }}</div>
                            <div class="music-song-info">
                                <div class="music-song-name">{{ song.name }}</div>
                                <div class="music-song-artist">{{ song.artists }} - {{ song.album }}</div>
                            </div>
                            <div class="song-duration">{{ formatMusicTime(song.duration) }}</div>
                        </div>
                        <!-- 加载更多指示器 -->
                        <div v-if="musicPlaylistVisibleCount < (musicCurrentPlaylistDetail.tracks || []).length"
                            class="music-load-more">
                            <i class="fas fa-spinner fa-spin"></i> 滚动加载更多...
                        </div>
                    </div>
                </div>
            </div>
    </div><!-- End music-bg-wrapper (Scalable content) -->

    <!-- Floating Bottom Player Bar -->
    <div class="music-bottom-bar" :class="{ 'expanded': musicShowFullPlayer }">
        <!-- 点击背景层 (点击除按钮外的区域展开) -->
        <div class="bar-click-layer" v-if="musicCurrentSong" @click="musicToggleFullPlayer()"></div>

        <div class="bar-progress" @click="musicSeekByClick($event)" role="slider" :aria-valuenow="musicProgress"
            aria-valuemin="0" aria-valuemax="100" aria-label="播放进度">
            <div class="bar-fill" :style="{ width: musicProgress + '%' }"></div>
        </div>

        <div class="bar-left">
            <!-- 收起状态：显示封面和歌曲信息 -->
            <transition name="bar-left-fade">
                <div class="bar-left-content" v-if="!musicShowFullPlayer" key="cover"
                    @click="musicCurrentSong && musicToggleFullPlayer()">
                    <template v-if="musicCurrentSong">
                        <div class="bar-cover-wrapper">
                            <img :src="musicCurrentSong.cover + '?param=100y100'" class="bar-cover"
                                :alt="musicCurrentSong.name + ' 封面'">
                            <div class="bar-cover-hover">
                                <i class="fas fa-chevron-up"></i>
                            </div>
                        </div>
                        <div class="bar-info">
                            <div class="bar-title"
                                :class="{ 'scrolling': musicCurrentSong && musicCurrentSong.name && musicCurrentSong.name.length > 20 }">
                                <span>{{ musicCurrentSong.name }}{{ musicCurrentSong.name.length > 20 ? '　　　' +
                                    musicCurrentSong.name : '' }}</span></div>
                            <div class="bar-artist">{{ musicCurrentSong.artists }}</div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="bar-cover-wrapper">
                            <div class="bar-cover"
                                style="display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                                <i class="fas fa-music" style="opacity: 0.2;"></i>
                            </div>
                        </div>
                        <div class="bar-info">
                            <div class="bar-title" style="opacity: 0.5;">未在播放</div>
                            <div class="bar-artist" style="opacity: 0.3;">选择歌曲开始享受音乐</div>
                        </div>
                    </template>
                </div>
            </transition>
            <!-- 展开状态：显示收起按钮 -->
            <transition name="bar-left-fade">
                <div class="bar-left-content bar-collapse-btn" v-if="musicShowFullPlayer" key="collapse"
                    @click="musicToggleFullPlayer()">
                    <div class="bar-cover-wrapper collapse-btn-wrapper">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="bar-info">
                        <div class="bar-title">收起歌词</div>
                    </div>
                </div>
            </transition>
        </div>

        <div class="bar-center">
            <button class="ctrl-btn" @click="musicToggleShuffle" aria-label="随机播放" :aria-pressed="musicShuffleEnabled"
                :disabled="!musicCurrentSong"
                :style="{ color: musicShuffleEnabled ? 'var(--primary-color)' : '', opacity: !musicCurrentSong ? 0.3 : 1 }">
                <i class="fas fa-random" aria-hidden="true"></i>
            </button>
            <button class="ctrl-btn" @click="playPrevious" aria-label="上一首" :disabled="!musicCurrentSong"
                :style="{ opacity: !musicCurrentSong ? 0.3 : 1 }">
                <i class="fas fa-step-backward" aria-hidden="true"></i>
            </button>
            <button class="ctrl-btn play" @click="musicTogglePlay" :aria-label="musicPlaying ? '暂停' : '播放'"
                :disabled="!musicCurrentSong" :style="{ opacity: !musicCurrentSong ? 0.5 : 1 }">
                <i :class="musicPlaying ? 'fas fa-pause' : 'fas fa-play'" style="margin-left: 2px;"
                    aria-hidden="true"></i>
            </button>
            <button class="ctrl-btn" @click="playNext" aria-label="下一首" :disabled="!musicCurrentSong"
                :style="{ opacity: !musicCurrentSong ? 0.3 : 1 }">
                <i class="fas fa-step-forward" aria-hidden="true"></i>
            </button>
            <button class="ctrl-btn" @click="musicToggleRepeat" aria-label="循环模式" :disabled="!musicCurrentSong"
                :aria-pressed="musicRepeatMode !== 'none'"
                :style="{ color: musicRepeatMode !== 'none' ? 'var(--primary-color)' : '', opacity: !musicCurrentSong ? 0.3 : 1 }">
                <i :class="musicRepeatMode === 'one' ? 'fas fa-redo-alt' : 'fas fa-redo'" aria-hidden="true"></i>
            </button>
        </div>

        <div class="bar-right">
            <div class="time-text" aria-live="off" :style="{ opacity: !musicCurrentSong ? 0.3 : 0.6 }">{{
                formatMusicSeconds(musicCurrentTime) }} / {{
                formatMusicSeconds(musicDuration) }}
            </div>
            <button class="icon-btn-sm" @click="musicShowPlaylistDrawer = !musicShowPlaylistDrawer" aria-label="播放队列"
                :aria-expanded="musicShowPlaylistDrawer"
                :style="{ color: musicShowPlaylistDrawer ? 'var(--primary-color)' : '' }">
                <i class="fas fa-list-ul" aria-hidden="true"></i>
            </button>
            <button class="icon-btn-sm" @click="musicMuted = !musicMuted" :aria-label="musicMuted ? '取消静音' : '静音'"
                :aria-pressed="musicMuted" :disabled="!musicCurrentSong"
                :style="{ opacity: !musicCurrentSong ? 0.3 : 1 }">
                <i :class="musicMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up'" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- Playlist Drawer (Floating) -->
    <transition name="drawer-slide">
        <div class="music-playlist-drawer" v-if="musicShowPlaylistDrawer" role="dialog" aria-label="播放队列">
            <div class="playlist-header">
                <span>播放队列</span>
                <span class="playlist-count">{{ musicPlaylist.length }} 首</span>
            </div>
            <div class="playlist-content">
                <div class="playlist-item" v-for="(song, index) in musicPlaylist" :key="song.id"
                    :class="{ active: musicCurrentSong && song.id === musicCurrentSong.id }" @click="musicPlay(song)"
                    tabindex="0" @keyup.enter="musicPlay(song)">
                    <div v-if="musicCurrentSong && song.id === musicCurrentSong.id && musicPlaying"
                        class="playlist-item-icon playing">
                        <i class="fas fa-volume-up" aria-hidden="true"></i>
                    </div>
                    <div v-else class="playlist-item-icon index">{{ index + 1 }}</div>

                    <div class="song-name">{{ song.name }}</div>
                    <div class="song-artist">{{ song.artists }}</div>
                </div>
                <div v-if="musicPlaylist.length === 0" class="empty-state-mini">
                    队列为空
                </div>
            </div>
        </div>
    </transition>

    <!-- Music Login Modal (网易云登录) -->
    <div v-if="musicShowLoginModal" class="music-login-modal">
        <div class="music-login-content">
            <h2>网易云音乐登录</h2>
            <div class="qr-container">
                <img v-if="musicQrImg" :src="musicQrImg" class="qr-image">
                <div v-else-if="musicQrExpired" class="qr-expired" @click="musicGenerateLoginQr">
                    <i class="fas fa-redo"></i>
                    <p>二维码已过期，点击刷新</p>
                </div>
                <div v-else class="qr-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            <p class="login-status">{{ musicLoginStatusText }}</p>
            <button class="btn btn-secondary" @click="musicShowLoginModal = false">关闭</button>
        </div>
    </div>

    <div v-if="musicShowUserDropdown" class="dropdown-backdrop" @click="musicShowUserDropdown = false"></div>

    <!-- Full Screen Player (SPlayer Style) -->
    <transition name="full-player-fade">
        <div class="music-full-player" v-if="musicShowFullPlayer && musicCurrentSong"
            :class="{ 'playing': musicPlaying }">

            <!-- Top Header (简化版，收起按钮在底部bar) -->
            <div class="full-player-header">
                <div class="header-spacer"></div>
                <div class="header-right">
                    <button class="header-btn" title="歌词模式">
                        <i class="fas fa-quote-left"></i>
                    </button>
                    <button class="header-btn" title="全屏" @click="toggleFullScreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>

            <div class="full-player-body">
                <!-- Left: Album Art & Info -->
                <div class="full-player-left">
                    <div class="full-player-cover-container">
                        <img :src="musicCurrentSong.cover + '?param=1000y1000'" class="full-player-cover"
                            :alt="musicCurrentSong.name">
                    </div>
                    <div class="full-player-info">
                        <h1 class="full-player-title">{{ musicCurrentSong.name }}</h1>
                        <div class="full-player-meta-row">
                            <i class="fas fa-user-circle"></i>
                            <span class="full-player-artist">{{ musicCurrentSong.artists }}</span>
                        </div>
                        <div class="full-player-meta-row" v-if="musicCurrentSong.album">
                            <i class="fas fa-compact-disc"></i>
                            <span class="full-player-album">{{ musicCurrentSong.album }}</span>
                        </div>
                    </div>
                </div>

                <!-- Right: Lyrics -->
                <div class="full-player-right">
                    <div class="full-lyrics-container" ref="lyricsContainer">
                        <!-- AMLL will be injected here, fallback to simple lyrics if not available -->
                        <div v-if="musicLyrics.length === 0" class="lyric-empty">
                            <i class="fas fa-music"></i>
                            <p>暂无歌词</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

</div>